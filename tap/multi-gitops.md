# GitOps

ë³¸ ê³¼ì •ì—ì„œëŠ” GitOps ì ‘ê·¼ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ Kubernetes êµ¬ì„±ì„ ì›ê²© Git ì €ì¥ì†Œë¡œ í‘¸ì‹œí•˜ë„ë¡ Supply Chainì„ ì„¤ì •í•©ë‹ˆë‹¤.
í˜„ GitOps í…ŒìŠ¤íŠ¸ëŠ” ë©€í‹°í´ëŸ¬ìŠ¤ í™˜ê²½ì—ì„œ êµ¬ì„±ì´ ë˜ë©°, ì•„ë˜ tap-value.yaml íŒŒì¼ì€ Build í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œ ìˆ˜í–‰í•˜ì—¬ Run í´ëŸ¬ìŠ¤í„°ì— Appì´ ë°°í¬ê°€ ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. 
í•´ë‹¹ ì‹¤ìŠµì€ ootb_supply_chain_testing_scanningë¡œ ì§„í–‰í•©ë‹ˆë‹¤.


## 0. contexts ì •ë³´ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
### 1) í˜„ì¬ì˜ Cluster ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
~~~
kubectl config get-contexts
~~~

### 2) ì‹¤ìŠµì í™˜ê²½ì˜ build Clusterë¡œ contextsë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
~~~
kubectl config use-context 'build cluster AUTHINFO'
kubectl config use-context build@tkgm01
~~~

## 1. GitOps ì ìš©
### 1) HTTP(S) Basic-auth
êµ¬ì„± ì •ë³´ë¥¼ ë‹´ì„ repositoryê°€ https:// ë˜ëŠ” http:// ë¥¼ ì‚¬ìš©í•œë‹¤ë©´, Kubernetes ì‹œí¬ë¦¿ì€ ë‹¤ìŒê³¼ ê°™ì´ í•´ë‹¹ repositoryì— ëŒ€í•œ credentialì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. <br/>
ë‹¤ìŒ Yaml íŒŒì¼ ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì—¬ ì‘ì„±í•©ë‹ˆë‹¤. GIT-USERNAMEì—ëŠ” ë³¸ì¸ì˜ github id, GIT-PASSWORDì—ëŠ” ë³¸ì¸ì˜ github ë¹„ë°€ë²ˆí˜¸ í˜¹ì€ token ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. <br/>

~~~
apiVersion: v1
kind: Secret
metadata:
  name: git-http  # `git-ssh` is the default name.
                        #   - operators can change such default by using the
                        #     `gitops.ssh_secret` property in `tap-values.yaml`
                        #   - developers can override by using the workload parameter
                        #     named `gitops_ssh_secret`.
  annotations:
    tekton.dev/git-0: https://github.com        # ! required
type: kubernetes.io/basic-auth          # ! required
stringData:
  username: GIT-USERNAME
  password: GIT-PASSWORD
~~~

ì‘ì„± ì™„ë£Œ í›„ í•´ë‹¹ íŒŒì¼ì„ ì ìš©í•©ë‹ˆë‹¤.

~~~
kubectl apply -f gitops-http-auth.yaml
~~~

### 2) ServiceAccount ì‘ì„±
secret ìƒì„± ì´í›„ì—ëŠ” workloadì—ì„œ ì‚¬ìš©í•˜ëŠ” serviceaccountì™€ ë¶™ì´ëŠ” ê³¼ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ìŒ yaml íŒŒì¼ì„ ì ìš©í•©ë‹ˆë‹¤.
~~~
apiVersion: v1
kind: ServiceAccount
metadata:
  name: default
secrets:
  - name: registry-credentials
  - name: tap-registry
  - name: git-http
imagePullSecrets:
  - name: registry-credentials
  - name: tap-registry
~~~

### 3) tap-values.yaml íŒŒì¼ ìˆ˜ì •
tap-values.yamlì˜ ootb_supply_chain í•­ëª©ì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•©ë‹ˆë‹¤. <br/>
GIT-USERNAMEì—ëŠ” ë³¸ì¸ì˜ github ê³„ì • ì •ë³´ë¥¼ ì…ë ¥í•˜ë©°, ì´ë•Œ ë³¸ì¸ì˜ ê³„ì • ì•„ë˜ì— tanzu-java-web-app ì´ë¼ëŠ” Repository ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì§„í–‰í•©ë‹ˆë‹¤.
~~~
supply_chain: testing_scanning
ootb_supply_chain_testing_scanning: # Optional if the corresponding shared keys are provided.
  registry:
    server: "your-image-repo-url"
    repository: "tanzu-application-platform/supply-chain"
  gitops:
    server_address: https://github.com/
    repository_owner: <your-git-repository-owner> #tanzukorea 
    repository_name: <your-git-repository_name>   #tap-gitops
    branch: main
    ssh_secret: git-http  # 1ì—ì„œ ë§Œë“  HTTP(S) Basic-auth ê¸°ë°˜ì˜ Secret 
    commit_strategy: pull_request
    pull_request:
      server_kind: github
      commit_branch: ""
      pull_request_title: ready for review
      pull_request_body: generated by supply chain
 ~~~
ë‹¤ìŒìœ¼ë¡œ ìˆ˜ì •ëœ profileì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

~~~
tanzu package installed update tap -p tap.tanzu.vmware.com -v 1.4.2 --values-file tap-build-values.yaml -n tap-install
~~~

### 4) ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
#### 1) ë‹¤ìŒê³¼ ê°™ì€ workload.yaml íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤. <br/>

~~~
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  name: tanzu-java-web-app-test
  labels:
    app.kubernetes.io/part-of: tanzu-java-web-app-test
    apps.tanzu.vmware.com/workload-type: web
    apps.tanzu.vmware.com/has-tests: "true"
    #metric = concurrency
spec:
  params:
  - name: testing_pipeline_matching_labels
    value:
      apps.tanzu.vmware.com/pipeline: test
      apps.tanzu.vmware.com/language: java
  source:
    git:
      ref:
        branch: master
      url: https://github.com/haewons-tanzu/tanzu-java-web-app
~~~

#### 2) ì•„ë˜ì™€ ê°™ì´ kubectl ëª…ë ¹ì–´ë¡œ ìˆ˜í–‰ì„ í•˜ê±°ë‚˜, <br/>
~~~
kubectl apply -f workload.yaml -n {namespace}
~~~

ì•„ë˜ì™€ ê°™ì´ tanzu clië¡œ workloadë¥¼ ìƒì„± í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
~~~
tanzu apps workload apply -f tanzu-java-web-app-stg.yaml -n {namespace}
ğŸ” Create workload:
      1 + |---
      2 + |apiVersion: carto.run/v1alpha1
      3 + |kind: Workload
      4 + |metadata:
      5 + |  labels:
      6 + |    app.kubernetes.io/part-of: tanzu-java-web-app-test
      7 + |    apps.tanzu.vmware.com/workload-type: web
      8 + |  name: tanzu-java-web-app-test
      9 + |  namespace: dev-team-01
     10 + |spec:
     11 + |  params:
     12 + |  - name: testing_pipeline_matching_labels
     13 + |    value:
     14 + |      apps.tanzu.vmware.com/language: java
     15 + |      apps.tanzu.vmware.com/pipeline: test
     16 + |  source:
     17 + |    git:
     18 + |      ref:
     19 + |        branch: main
     20 + |      url: https://github.com/haewons-tanzu/tanzu-java-web-app
â“ Do you want to create this workload? [yN]: y
~~~


#### 3) ë°°í¬ë˜ê³  ìˆëŠ” workload ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. <br/>
~~~
tanzu apps workload tail tanzu-java-web-app-test --namespace dev-team-01 --timestamp --since 1h
~~~

ì•„ë˜ì™€ ê°™ì€ ë¡œê·¸ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![](../images/git-clone-and-push.png)


#### 4) build í´ëŸ¬ìŠ¤í„°ì—ì„œ ì•„ë˜ì™€ ê°™ì€ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬, "workload-name-deliverable" ex)tanzu-java-web-app-test-deliverableì˜ configmapì„ ì¡°íšŒí•©ë‹ˆë‹¤. <br/>
~~~
kubectl get configmap tanzu-java-web-app-test-deliverable --namespace dev-team-01 -o go-template='{{.data.deliverable}}'

apiVersion: carto.run/v1alpha1
kind: Deliverable
metadata:
  name: tanzu-java-web-app-test
  labels:
    app.kubernetes.io/part-of: tanzu-java-web-app-test
    apps.tanzu.vmware.com/has-tests: "true"
    apps.tanzu.vmware.com/workload-type: web
    app.kubernetes.io/component: deliverable
    app.tanzu.vmware.com/deliverable-type: web
    carto.run/cluster-template-name: external-deliverable-template
    carto.run/resource-name: deliverable
    carto.run/supply-chain-name: source-test-scan-to-url
    carto.run/template-kind: ClusterTemplate
    carto.run/template-lifecycle: mutable
    carto.run/workload-name: tanzu-java-web-app-test
    carto.run/workload-namespace: dev-team-01
spec:
  params:
  - name: gitops_ssh_secret
    value: git-creds
  source:
    git:
      url: https://github.com/haewons-tanzu/tap-gitops-repo.git
      ref:
        branch: master
    subPath: config/dev-team-01/tanzu-java-web-app-test
~~~


#### 5) Deliverable ì•„ë˜ì™€ ê°™ì´ ì €ì¥í•©ë‹ˆë‹¤. <br/>
~~~
kubectl get configmap tanzu-java-web-app-test-deliverable --namespace dev-team-01 -o go-template='{{.data.deliverable}}' >  deliverable.yaml
~~~


#### 6) ì•„ë˜ì™€ ê°™ì´ ìœ„ workloadì„ ë°°í¬ í•  run í´ëŸ¬ìŠ¤í„°ë¡œ contextì„ ë³€ê²½í•©ë‹ˆë‹¤. <br/>
~~~
kubectl config use-context run-cluster-admin@run-cluster
Switched to context "run-cluster-admin@run-cluster".
~~~

#### 7) run í´ëŸ¬ìŠ¤í„°ì— ì•„ë˜ì™€ ê°™ì´ deliverableì„ apply í•©ë‹ˆë‹¤. <br/>
~~~
kubectl apply -f deliverable.yaml -n dev-team-01
~~~

- * 5~7ì˜ ì‘ì—…ì€ ìµœì´ˆ workload ë°°í¬ì‹œ ìµœì´ˆ 1íšŒë§Œ ìˆ˜í–‰ í•˜ë©´ ë©ë‹ˆë‹¤. 

#### 8) run í´ëŸ¬ìŠ¤í„°ì—ì„œ delicerablesì„ ì¡°íšŒí•©ë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì´ Falseì¸ê²ƒì„ í™•ì¸ í•©ë‹ˆë‹¤. READY Falseì¸ ì´ìœ ëŠ”, ìŠ¹ì¸ì— ìš”ì²­ì— ì¸í•œ í™•ì¸ì´ ì´ë£¨ì–´ ì§€ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë‹¤ìŒ ì‹¤ìŠµì„ í†µí•´  pull request ìš”ì²­ì„ í™•ì¸ í•˜ê³ , Merge Pull request ì‹¤ìŠµì„ í•´ë³´ê² ìŠµë‹ˆë‹¤. <br/>
~~~
kubectl get deliverables -n dev-team-01
NAME                      SOURCE                                                 DELIVERY         READY   REASON                 AGE
tanzu-java-web-app-test   https://github.com/haewons-tanzu/tap-gitops-repo.git   delivery-basic   False   HealthyConditionRule   48s
~~~

### 5) git ìŠ¹ì¸ ìš”ì²­ í”„ë¡œì„¸ìŠ¤ ìˆ˜í–‰ <br/>
#### 1) TAP GUI íŒŒì´í”„ë¼ì¸ í™•ì¸. ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” ìŠ¹ì¸ì ˆì°¨ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì´ë©°, source urlì„ í´ë¦­í•˜ì—¬ ìŠ¹ì¸ ì ˆì°¨ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. <br/>
![](../images/gitops-gui1.png)

#### 2) pull request í™•ì¸ <br/>
![](../images/pull-request.png)

#### 3) merge pull request <br/>
![](../images/merge-pull-request.png)

#### 4) merge ìŠ¹ì¸ <br/>
![](../images/confirm-merge.png)

#### 5) merge ìŠ¹ì¸ í™•ì¸ <br/>
![](../images/merge-check.png)

### 6) run í´ëŸ¬ìŠ¤í„°ì—ì„œ delicerablesì„ ì¡°íšŒ ë° httpproxy ì¡°íšŒ <br/>
~~~
kubectl get deliverables,httpproxy -n dev-team-01

NAME                                            SOURCE                                                 DELIVERY         READY   REASON   AGE
deliverable.carto.run/tanzu-java-web-app-test   https://github.com/haewons-tanzu/tap-gitops-repo.git   delivery-basic   True    Ready    119m


NAME                                                                                          FQDN                                                         TLS SECRET                                               STATUS   STATUS DESCRIPTION
httpproxy.projectcontour.io/tanzu-java-web-app-test-contour78179a831912511c61e6e233bdbedd72   tanzu-java-web-app-test-dev-team-01.run.tap.tanzukorea.xyz   dev-team-01/route-933db279-434d-42c1-b1e7-2e96101534e2   valid    Valid HTTPProxy
httpproxy.projectcontour.io/tanzu-java-web-app-test-contouraef609d6cca1b3a330865551acf79e7c   tanzu-java-web-app-test.dev-team-01                          kube-system/tap-wildcard-cert                            valid    Valid HTTPProxy
httpproxy.projectcontour.io/tanzu-java-web-app-test-contourbd0ffc463839f2f4142c90f1bf4b0214   tanzu-java-web-app-test.dev-team-01.svc                      kube-system/tap-wildcard-cert                            valid    Valid HTTPProxy
httpproxy.projectcontour.io/tanzu-java-web-app-test-contoure57f5e178288f40bff602732bf1a0ea4   tanzu-java-web-app-test.dev-team-01.svc.cluster.local        kube-system/tap-wildcard-cert                            valid    Valid HTTPProxy
~~~

### 7) TAP GUI íŒŒì´í”„ë¼ì¸ì—ì„œ í™•ì¸ <br/>
![](../images/git-ops-result.png)


### 8) tanzu-java-web-app-test-dev-team-01.run.tap.tanzukorea.xyz ì ‘ì† í™•ì¸  <br/>
![](../images/workload-result.png)
